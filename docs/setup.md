# Руководство по настройке и запуску бота

Данный документ описывает полный процесс подготовки окружения, развертывания и эксплуатации проекта Telegram‑бота с экспертными модулями. Руководство покрывает локальную разработку, запуск через Docker и основные операции администрирования.

## 1. Предварительные требования
- **ОС**: Linux или macOS (Windows через WSL2).
- **Python**: версия 3.11+.
- **Docker и Docker Compose**: последняя стабильная версия.
- **Make**: для запуска вспомогательных команд.
- **Телеграм‑бот**: токен BotFather и HTTPS‑домен для вебхука.
- **Stars (XTR)**: токен провайдера платежей.
- **S3‑совместимое хранилище**: ключи доступа и бакет для файлов.

## 2. Клонирование репозитория
```bash
git clone https://example.com/TGP_ASTRO.git
cd TGP_ASTRO
```

## 3. Создание виртуального окружения
Используйте любой менеджер (venv/poetry). Пример с venv:
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
pip install -r requirements-dev.txt
```

## 4. Настройка переменных окружения
Скопируйте файл `.env.sample` в `.env` и заполните значения:
```bash
cp .env.sample .env
```
Основные группы переменных:
- **Telegram**: `BOT_TOKEN`, `WEBHOOK_URL`.
- **База данных**: `DATABASE_URL` (формат `postgresql+asyncpg://user:pass@db:5432/app`).
- **Redis**: `REDIS_URL`.
- **S3/MinIO**: `S3_ENDPOINT`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`, `S3_BUCKET`.
- **Stars**: `STARS_PROVIDER_TOKEN`.
- Прочие секреты: `SECRET_KEY`, `LOG_LEVEL` и т. д.

## 5. Сборка и запуск Docker‑сервисов
Для разработки проект запускается через `docker-compose`:
```bash
make build       # сборка образов
make up          # поднимает app, db, redis, minio, worker
make logs        # просмотр логов
make down        # остановка и очистка
```
Сервис `app` стартует FastAPI и aiogram‑бот через вебхук. `worker` обслуживает очереди (Celery или RQ).

## 6. Инициализация базы данных
В контейнере приложения выполните миграции Alembic:
```bash
make migrate
```
При первом запуске создадутся все таблицы (`users`, `profiles`, `orders` и т. д.) согласно [DDL](../AGENTS.md).

## 7. Загрузка и валидация ассетов
Структура каталогов находится в `assets/`. Для каждой колоды или набора:
1. Создайте директорию `assets/<expert>/<id>`.
2. Поместите изображения и манифест (`deck.json`, `set.json`, `lexicon.json` и т. п.).
3. Запустите ингестер:
   ```bash
   make ingest
   ```
   Он проверит размеры, обязательные поля и занесёт данные в таблицу `decks`.
4. Проверьте результат через `/admin/decks` или по логам.

## 8. Регистрация вебхука Telegram
После запуска сервиса выполните команду:
```bash
make set-webhook
```
Она обращается к Bot API и регистрирует `WEBHOOK_URL/tg/webhook` с `allowed_updates=["message","callback_query","my_chat_member","pre_checkout_query"]`.
Для проверки работоспособности есть healthcheck `/health`.

## 9. Работа с плагинами экспертов
Модули экспертов располагаются в `app/experts/*`. Каждый реализует интерфейс из `app/core/plugins`:
- `form_steps(locale)` – описание шагов формы.
- `prepare()` – генерация детерминированных фактов (Draw).
- `compose()` – сборка изображений.
- `write()` и `verify()` – текст и проверка.
Новые плагины регистрируются автоматически при наличии `plugin_id`.

## 10. Платежи и квоты
В модуле `app/core/payments` настроены продукты:
- `pack_3`, `pack_10` – пакетные квоты.
- `unlimited_30d`, `sub_30d` – безлимит.
Рабочий цикл Stars:
1. `sendInvoice` с валютой `XTR` и токеном `STARS_PROVIDER_TOKEN`.
2. `pre_checkout_query` → `answerPreCheckoutQuery`.
3. `successful_payment` → создание `entitlement` и списание.
Ограничения использования контролируются в `app/core/limits` (fair‑use, анти‑флуд, параллелизм ≤ 2).

## 11. Телеметрия и админ‑панель
Все события отправляются через `app/core/telemetry.track()`. Доступные endpoints:
- `/admin/metrics` – MAU/DAU, конверсии, скорость генерации.
- `/admin/decks` – список колод и статус валидации.
- `/admin/broadcast` – опциональная рассылка.

## 12. Тестирование и качество кода
Перед коммитом запускайте проверки:
```bash
make lint       # ruff + black
make typecheck  # mypy --strict
make test       # pytest с покрытием
```
Цель – покрытие ≥90 %. Все команды выполняются внутри контейнера или активного venv.

## 13. Деплой
В продакшене достаточно повторить шаги Docker‑сборки на сервере с настроенным доменом для HTTPS‑вебхука. Переменные окружения задаются через файлы или секреты оркестратора. Рекомендуется настроить мониторинг логов и метрик, а также политики резервного копирования бакета S3 и базы данных.

## 14. Полезные команды Makefile
- `make up` / `make down` – запуск и остановка всего стека.
- `make shell` – интерактивная оболочка внутри контейнера приложения.
- `make fmt` – форматирование исходников.
- `make ingest` – повторная валидация ассетов.
- `make set-webhook` / `make delete-webhook` – управление вебхуком.

Следуя данному руководству, вы получите полностью функционирующий бот с поддержкой всех экспертов, платежей Stars и телеметрии.
