# Полное руководство по настройке и развёртыванию бота

Документ описывает каждый шаг подготовки локальной среды, получения всех ключей и токенов, запуска в контейнерах и публикации приложения в сервисе Railway. Все инструкции приводятся исключительно на русском языке без сокращений.

## 1. Подготовка аккаунтов и внешних сервисов

### 1.1 Создание телеграм‑бота и получение токена
1. Откройте приложение Telegram на телефоне или в веб‑версии.
2. Найдите пользователя `@BotFather` и начните с ним диалог командой `/start`.
3. Введите команду `/newbot`, далее укажите отображаемое имя бота и уникальное имя, заканчивающееся на `bot` (например, `my_astrology_bot`).
4. BotFather вернёт длинный строковый токен вида `1234567890:ABC‑DEF1234ghIklmnopQRSTUVwxyZ`. Этот токен необходимо записать в переменную окружения `TELEGRAM_TOKEN`.

### 1.2 Подключение платёжной системы Telegram Stars
1. В чате с `@BotFather` выберите созданного бота командой `/mybots`.
2. Нажмите кнопку **Payments** и далее **Connect Payment Provider**.
3. Выберите провайдера, который поддерживает валюту Stars (XTR), например `@CryptoBot`.
4. Следуйте инструкциям провайдера, после подключения вы получите строку `provider token` вида `12345:LIVE:67890`. Этот токен сохраните в переменную `STARS_API_KEY`.

### 1.3 Регистрация в Supabase и настройка хранилища объектов S3
1. Перейдите на сайт [https://supabase.com](https://supabase.com) и создайте аккаунт через GitHub или электронную почту.
2. Создайте новый проект, укажите регион и сложный пароль для базы данных Supabase.
3. После создания проекта откройте раздел **Storage** и нажмите **Create new bucket**. Задайте имя бакета, например `tgp-assets`, и выберите режим `Public` или `Private` в зависимости от требований к доступу. Название бакета используйте в переменной `S3_BUCKET`.
4. Перейдите в **Settings → Storage → S3 access** и нажмите **Create access token**. Сервис сгенерирует `Access Key` и `Secret Key`. Эти значения нужно поместить соответственно в `S3_ACCESS_KEY` и `S3_SECRET_KEY`.
5. На странице **Project Settings → API** скопируйте значение **Project URL**. Для доступа по протоколу S3 используйте адрес `https://<project_ref>.supabase.co/storage/v1/s3`, где `<project_ref>` — это уникальный идентификатор проекта. Этот адрес укажите в переменной `S3_ENDPOINT`.

### 1.4 Регистрация в Railway и подготовка инфраструктуры
1. Зайдите на [https://railway.app](https://railway.app) и авторизуйтесь через GitHub.
2. Нажмите **New Project**, затем **Deploy from GitHub repo** и выберите репозиторий `TGP_ASTRO`.
3. Внутри проекта Railway нажмите **Add → Database** и создайте сервис PostgreSQL. После создания откройте вкладку **Connect** и скопируйте строку подключения `postgresql://user:password@host:port/database`. Позже она понадобится для переменной `DATABASE_URL`.
4. Аналогично добавьте сервис **Redis** и на вкладке **Connect** скопируйте строку `redis://:password@host:port/0` для переменной `REDIS_URL`.
5. В разделе **Variables** добавьте все переменные, описанные далее в файле `.env`. Railway безопасно хранит эти значения и подставляет их при запуске контейнера.
6. Railway автоматически строит образ из `Dockerfile`. В разделе **Deployments** можно отслеживать процесс сборки и лог работы.

## 2. Клонирование исходного кода
```bash
git clone https://example.com/TGP_ASTRO.git
cd TGP_ASTRO
```

## 3. Подготовка локального окружения разработки

### 3.1 Создание виртуального окружения и установка зависимостей
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
pip install -r requirements-dev.txt
```

### 3.2 Копирование файла переменных окружения
```bash
cp .env.sample .env
```

## 4. Заполнение файла `.env`
Ниже перечислены переменные окружения и способ их получения. Значения указывайте без кавычек.

| Переменная | Назначение | Откуда получить |
|-----------|------------|----------------|
| `APP_HOST` | адрес, на котором приложение слушает входящие соединения | для локальной разработки используйте `0.0.0.0` |
| `APP_PORT` | порт веб‑сервера | локально `8000`; в Railway назначается автоматически |
| `DATABASE_URL` | строка подключения к базе данных PostgreSQL | вкладка **Connect** соответствующего сервиса в Railway |
| `REDIS_URL` | строка подключения к серверу Redis | вкладка **Connect** сервиса Redis в Railway |
| `TELEGRAM_TOKEN` | токен, полученный от BotFather | раздел 1.1 этого руководства |
| `TELEGRAM_WEBHOOK_URL` | полный адрес публичного вебхука без суффикса `/tg/webhook` | после первого деплоя в Railway откройте **Settings → Domains** и скопируйте выделенный домен вида `https://project.up.railway.app` |
| `STARS_API_KEY` | токен провайдера платежей Stars | раздел 1.2 |
| `S3_ENDPOINT` | адрес S3 интерфейса Supabase | раздел 1.3 |
| `S3_ACCESS_KEY` | ключ доступа к Supabase | раздел 1.3 |
| `S3_SECRET_KEY` | секретный ключ Supabase | раздел 1.3 |
| `S3_BUCKET` | имя бакета в Supabase Storage | раздел 1.3 |
| `SECRET_KEY` | произвольная длинная строка для подписи токенов и шифрования | сгенерируйте командой `openssl rand -hex 32` |
| `LOG_LEVEL` | уровень подробности логов (`INFO`, `DEBUG` и так далее) | устанавливается вручную |

После заполнения файла `.env` проверьте корректность значений и сохраните изменения.

## 5. Сборка и запуск локальной инфраструктуры через Docker
```bash
make build       # сборка образов приложений и вспомогательных сервисов
make up          # запуск контейнеров приложения, базы данных, Redis и локального MinIO
```
Команда `make logs` выводит журналы работы контейнеров, а `make down` останавливает и очищает их.

## 6. Выполнение миграций базы данных
После первого запуска контейнера приложения необходимо создать все таблицы:
```bash
make migrate
```
В логах вы увидите сообщения об успешном применении миграций.

## 7. Загрузка и проверка ассетов
1. В каталоге `assets` создайте подкаталог для нужного эксперта, например `assets/tarot/classic`.
2. Скопируйте изображения и файл манифеста `deck.json` (или `set.json`, `lexicon.json` для других экспертов) согласно структуре, описанной в `AGENTS.md`.
3. Запустите проверку:
   ```bash
   make ingest
   ```
   Скрипт проверит размеры файлов, обязательные поля в JSON и добавит запись в таблицу `decks`.
4. Убедитесь в корректности через маршрут `/admin/decks` или по сообщениям в консоли.

## 8. Регистрация вебхука Telegram
После получения публичного домена Railway и заполнения `TELEGRAM_WEBHOOK_URL` зарегистрируйте вебхук:
```bash
make set-webhook
```
Команда отправит запрос в Bot API и привяжет адрес `<TELEGRAM_WEBHOOK_URL>/tg/webhook`. Для проверки доступности откройте `https://<домен>/health` в браузере.

## 9. Плагины экспертов
Модули располагаются в каталоге `app/experts`. Каждый модуль должен экспортировать `plugin_id`, функции `form_steps`, `prepare`, `compose`, `write`, `verify`, а также `cost` и `cta`. Новые плагины автоматически загружаются при старте приложения, если соблюдён требуемый интерфейс.

## 10. Платежи и учёт квот
Платёжный модуль `app/core/payments` реализует продукты `pack_3`, `pack_10`, `unlimited_30d` и `sub_30d`. Последовательность обработки платежа:
1. бот отправляет счёт через метод `sendInvoice` с валютой `XTR` и токеном `STARS_API_KEY`;
2. Telegram вызывает `pre_checkout_query`, на которое приложение отвечает `answerPreCheckoutQuery` с параметром `ok=true`;
3. после события `successful_payment` создаётся запись `entitlement`, и квота пользователя уменьшается в соответствии со стоимостью запроса;
4. модуль `app/core/limits` контролирует суточные ограничения, защиту от частых запросов и параллельность не более двух запросов.

## 11. Телеметрия и административные интерфейсы
Каждое значимое действие отправляется через функцию `track` в модуле `app/core/telemetry`. Сервис предоставляет следующие маршруты для администрирования:
- `/admin/metrics` — статистика по активным пользователям, скорости генерации и конверсии;
- `/admin/decks` — проверка загруженных колод и наборов;
- `/admin/broadcast` — опциональная отправка рассылок по сегментам пользователей.

## 12. Тестирование и проверка качества
Перед фиксацией изменений выполняйте все проверки:
```bash
make lint       # проверка стиля кода линтерами ruff и black
make typecheck  # статический анализ типов mypy в строгом режиме
make test       # запуск модульных и сквозных тестов средствами pytest
```
Покрытие тестами должно быть не ниже девяноста процентов. Все команды выполняются внутри активированного виртуального окружения или внутри контейнера приложения.

## 13. Развёртывание на платформе Railway
1. Закоммитьте изменения и отправьте их в удалённый репозиторий GitHub: `git push origin main`.
2. Railway автоматически запустит сборку и развёртывание контейнера. Статус можно наблюдать на вкладке **Deployments**.
3. После успешного запуска выполните миграции базы данных в облаке командой:
   ```bash
   railway run make migrate
   ```
4. В разделе **Settings → Domains** скопируйте публичный домен Railway и обновите переменную `TELEGRAM_WEBHOOK_URL` в настройках проекта.
5. Выполните регистрацию вебхука уже в облаке:
   ```bash
   railway run make set-webhook
   ```
6. Теперь бот готов к работе. Все логи доступны во вкладке **Logs** соответствующего сервиса в Railway.

## 14. Полезные команды Makefile
- `make up` и `make down` — запуск и остановка всех контейнеров локальной среды.
- `make logs` — просмотр логов работающих контейнеров.
- `make shell` — интерактивная оболочка внутри контейнера приложения.
- `make fmt` — автоматическое форматирование исходного кода.
- `make ingest` — повторная проверка и индексация ассетов.
- `make set-webhook` и `make delete-webhook` — управление вебхуком Telegram.

Следуя приведённым шагам, вы получите полностью настроенный и готовый к эксплуатации бот с поддержкой всех экспертных модулей, оплатой через Telegram Stars и хранением файлов в Supabase.

