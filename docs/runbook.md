# Runbook

## Платежи Stars
Оплата производится через валюту Telegram Stars (XTR). Последовательность:
1. Бот отправляет счёт методом `sendInvoice`.
2. Пользователь подтверждает `pre_checkout_query`.
3. После `successful_payment` создаётся entitlement и уменьшается доступная квота.
4. При ошибке счёта или сети платёж отклоняется без списаний.

## Учёт квот
Каждая генерация списывает единицу квоты. Модуль `limits` хранит остаток в БД и проверяет:
- суточный лимит и параллельность ≤ 2;
- наличие активных `entitlement` после покупки Stars.
Отрицательные остатки блокируют новые запросы, пока пользователь не пополнит баланс.

## Типичные инциденты
- **Сбой оплаты** — не прошёл счёт, повторить запрос и проверить баланс Stars.
- **Превышена квота** — пользователь достиг лимита; предложить покупку пакета или безлимита.
- **Ошибка генерации** — `Verifier` вернул `false`; система пытается перегенерировать, после двух неудач квота не списывается.

## Быстрые действия
- `/terms` — отправляет ссылку на условия использования, помогает при вопросах о правах и ограничениях.
- `/privacy` — показывает политику конфиденциальности; использовать при запросах о данных.
- `/admin status` — административная команда, выводит состояние сервиса: баланс Stars, активные задания, состояние очередей. Применяется при мониторинге и расследовании инцидентов.
